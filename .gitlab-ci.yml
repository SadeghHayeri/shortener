image: docker:latest

services:
  - docker:dind

stages:
  - k8-deploy
  - build
  - test
  - k8s-deploy-canary

variables:
  PROJECT: shortener
  CI_REGISTRY: registry.gitlab.com
  CONTAINER_IMAGE: $CI_REGISTRY/sadeghhayeri/shortener/app:$CI_COMMIT_REF_SLUG-$CI_PIPELINE_ID
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

build-shortener:
  stage: build
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd src
    - docker build --pull -t $CONTAINER_IMAGE .
    - docker push $CONTAINER_IMAGE

deploy-k8-shortener:
  stage: k8-deploy
  tags:
    - docker
  script:
    - k8sversion=v1.11.5
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$k8sversion/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl
    - mkdir -p ~/.kube
    - echo $KUBE_CONFIG > ~/.kube/config
    - kubectl set image deployment/shortener shortener=$CONTAINER_IMAGE --record
